{% set path = path|default('') %}
{% set model = createModel('Files','storage') %}
{% set user_id = access().getId() %}  
{% set filesystem = model.getUserFilesystemName() %}
{% set filesystem_path = model.getUserFilesystemPath(user_id) %}
{% set result = service('storage').mountLocal(filesystem,filesystem_path) %}
{% set filesList = getDirectoryFiles(path,false,filesystem) %}
{% set items = paginate(filesList,'myfiles') %}  

{% set view_type = view_type|default(getViewType('files')) %}

{% if view_type == 'table' %}
<div class="ui big list" id="files_items">
{% else %}
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 lg:grid-cols-7 xl:grid-cols-10 gap-4" id="files_items">
{% endif %}

{% if items.getItems()|length == 0 %}
    <div class="ui item">..</div>
{% endif %}
{% for item in items.getItems() %}
    {%  set file = model.saveFile(item.path,user_id,{ 
            type: item.type,
            size: item.size,
            filesystem: filesystem,
            date_created: item.timestamp,
            mime_type: service('storage').getMimetype(item.path,filesystem)  
        },false) 
    %}
    {% if file.isDirectory() == true %}
        {% set items_count = getDirectoryFiles(item.path,false,filesystem)|length %}
    {% endif %}

    {% if item.path != 'bin' %}
        {% set path = item.path %}
        {% set count = items_count %}
        {% set file_type = file.getFileType() %}

        {% if view_type == 'table' %}           
            <div class="item" id="row_{{ file.uuid }}">   
                <div class="content">
                    {% if trash == 1 %}
                        {{ component('files>files.trash.actions',{ file: file }) }}
                    {% else %}
                        {{ component('files>files.view.items.actions',{ file: file }) }}
                    {% endif %}
                    {% if file.isDirectory() == true %}
                        <button class="ui basic disabled mini icon button">
                            <i class="icon"></i>
                        </button> 
                        <a class="ui link open-directory" path="{{ path }}" trash="{{ trash }}">
                            {{ component('files>files.file.icon',{ type: file_type, class: 'large ' ~ color_icon }) }} 
                            {{ file.file_name }}      
                        </a>                 
                    {% elseif trash != true %}      
                        <a class="ui basic mini icon button show-popup" href="{{ file.getDownloadUrl() }}" title="{{ labels.download }}">
                            <i class="icon blue download"></i>
                        </a>
                        <a class="ui link preview-file" uuid="{{ file.uuid }}">
                            {{ component('files>files.file.icon',{ type: file_type, class: 'large ' ~ color_icon }) }} 
                            {{ file.file_name }}  
                        </a>  
                    {% else %}          
                        {{ component('files>files.file.icon',{ type: file_type, class: 'large ' ~ color_icon }) }} 
                        {{ file.file_name }}         
                    {% endif %}
                    <div class="ui basic labels right floated">                                         
                        {% if file.hasPassword() == true %}
                            <div class="ui icon label show-popup" data-content="{{ labels.password }}">
                                <i class="icon blue lock"></i>   
                            </div>
                        {% endif %}           
                        <div class="ui label show-popup" data-content="{{ labels.date }}">
                            <i class="icon blue outline calendar"></i>
                            {{ file.date_created|dateFormat }}
                        </div>   
                        {% if file.isDirectory() == false %}
                            {% if file.isPublic() == true %}
                            <div class="ui green label">
                                {{ labels.public|pad(18,' ') }}
                            </div>
                            {% elseif file.hasPermissions() == true %}
                            <div class="ui olive label">
                                {{ labels.shared|pad(18,' ') }}
                            </div>
                            {% else %}
                            <div class="ui red label">
                                {{ labels.private|pad(18,' ') }}
                            </div>
                            {% endif %}               
                            <div class="ui label show-popup" data-content="{{ labels.size }}">                
                                {{ file.size|fileSize|padLeft(18,' ') }}
                            </div>  
                            <div class="ui label show-popup" data-content="{{ labels.downloads }}">
                                <i class="icon download"></i>                     
                                {{ file.downloads|padLeft(10,' ') }}        
                            </div>
                        {% endif %}     
                    </div>         
                </div>  
            </div>           
        {% else %}
            <div class="w-full h-full rounded border border-solid border-gray-400 overflow-hidden shadow-lg" id="row_{{ file.uuid }}">
                <div class="content p-2">
                    <div class="flex justify-between">
                        {% if trash == 1 %}
                            {{ component('files>files.trash.actions',{ file: file, class: 'mini basic button' }) }}
                        {% else %}
                            {{ component('files>files.view.items.actions',{ file: file, class: 'mini basic button' }) }}
                        {% endif %} 
                        <div class="pl-2 pt-1 font-bold show-popup" data-content="{{ file.file_name }}">                 
                            {{ file.file_name|sliceLabel(16,'...') }}                   
                        </div>      
                        {% if trash != true %}      
                        <div>
                            {% if file.isDirectory() == false %}   
                                <a class="ui icon mini basic button" href="{{ file.getDownloadUrl() }}">       
                                    <i class="icon blue show-popup download" title="{{ labels.download }}"></i>                  
                                </a>   
                            {% else %}
                                <a title="{{ labels.open }}" class="ui icon mini basic button open-directory show-popup" path="{{ path }}" trash="{{ trash }}">    
                                    <i class="icon blue open folder"></i>                    
                                </a>   
                            {% endif %}     
                        </div>
                        {% else %}
                        <div>
                            <button class="ui basic mini icon button restore-file show-popup" path="{{ file.path }}" uuid="{{ file.uuid }}" {{ buttons.restore.title|attr('title') }}>
                                <i class="trash restore olive alternate icon"></i>                  
                            </button> 
                        </div>
                        {% endif %}             
                    </div>               
                </div>   
                <div class="text-center">
                    {% if file.isDirectory() == true %}                          
                        <a class="ui link open-directory" path="{{ path }}" trash="{{ trash }}">    
                            <div class="mt-1">             
                                {{ component('files>files.file.icon',{ type: file_type, class: 'massive' }) }}   
                            </div>                        
                        </a>                           
                    {% elseif trash != true %}  
                        <a class="ui link preview-file" uuid="{{ file.uuid }}">                            
                            {% if file_type == 'image' %}
                                <img class="w-full h-32" src="{{ file.getViewImageUrl() }}">
                            {% else %} 
                                {{ component('files>files.file.icon',{ type: file_type, class: 'massive ' ~ color_icon }) }}                        
                            {% endif %}                            
                        </a>  
                    {% else %}
                        <div class="mt-1">  
                            {{ component('files>files.file.icon',{ type: file_type, class: 'massive' }) }}   
                        </div>      
                    {% endif %}     
                </div>   
                <div class="content p-2">      
                    <div class="ui mini basic labels mt-1">         
                        {% if file.isDirectory() == false %}                           
                            <div class="ui left pointing label show-popup" title="{{ labels.downloads }}">  
                                <i class="icon blue download"></i>                            
                                {{ file.downloads }}        
                            </div>               
                        {% endif %}          
                        {% if file.isPublic() == true %}
                            <div class="ui basic green label">
                                {{ labels.public }}
                            </div>
                        {% elseif file.hasPermissions() == true %}
                            <div class="ui basic olive label">
                                {{ labels.shared }}
                            </div>    
                        {% else %}   
                            <div class="ui basic red label">
                                {{ labels.private }}
                            </div>    
                        {% endif %} 
                        {% if file.hasPassword() == true %}
                            <div class="ui icon basic label show-popup" data-content="{{ labels.password }}">
                                <i class="icon blue lock"></i>   
                            </div>
                        {% endif %}
                    </div>                                        
                </div>         
                <div class="content meta p-2"> 
                    <div class="ui mini basic horizontal labels">        
                        <div class="ui label show-popup" data-content="{{ labels.date }}">
                            <i class="icon blue outline calendar"></i>
                            {{ file.date_created|dateFormat }}
                        </div>  
                        {% if file.isDirectory() == false %}
                            <div class="ui label show-popup right aligned" data-content="{{ labels.size }}">
                                {{ file.size|fileSize }}
                            </div>                                             
                        {% else %}
                            <div class="ui label show-popup right floated" data-content="{{ labels.items }}">
                                <div class="detail">
                                    {{ count }}                       
                                </div>
                                {{ labels.items }}
                            </div>
                        {% endif %} 
                    </div> 
                </div>  
            </div>           
        {% endif %}
    {% endif %}
{% endfor %}
</div>